// =====================================================
// GENERADOR DE CLIENTE PRISMA
// =====================================================
generator client {
  provider = "prisma-client-js"
}

// =====================================================
// FUENTE DE DATOS (PostgreSQL)
// =====================================================
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =====================================================
// ENUMS
// =====================================================

/// Estados de la cotización para manejar el flujo comercial
/// Puedes mapearlos en frontend:
/// ENVIADO → "Enviado", NEGOCIACION → "Negociación", etc.
enum CotizacionStatus {
  ENVIADO
  NEGOCIACION
  APROBADO
  NO_APROBADO
  EN_PAUSA
  REEMPLAZADA
}

// =====================================================
// MODELO: Role
// =====================================================
model Role {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  users     User[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =====================================================
// MODELO: User
// =====================================================
model User {
  id                Int       @id @default(autoincrement())
  name              String
  lastName          String
  email             String    @unique
  phone             String
  password          String
  roleId            Int
  role              Role      @relation(fields: [roleId], references: [id])
  mfaLastVerifiedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  emailOtps      EmailOtp[]
  trustedDevices TrustedDevice[]

  projects     Project[]
  cotizaciones Cotizacion[]
}

// =====================================================
// MODELO: Cliente
// =====================================================
model Cliente {
  id          Int      @id @default(autoincrement())
  empresa     String
  razonSocial String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  contactos ContactoEmpresa[]
  projects  Project[]

  @@unique([empresa, razonSocial])
  @@index([empresa])
}

// =====================================================
// MODELO: ContactoEmpresa
// =====================================================
model ContactoEmpresa {
  id        Int     @id @default(autoincrement())
  clienteId Int
  cliente   Cliente @relation(fields: [clienteId], references: [id], onDelete: Cascade)

  nombre    String
  email     String   @unique
  telefono  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projects     Project[]
  cotizaciones Cotizacion[]

  @@index([clienteId])
}

// =====================================================
// MODELO: EmailOtp
// =====================================================
model EmailOtp {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  codeHash  String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
}

// =====================================================
// MODELO: TrustedDevice
// =====================================================
model TrustedDevice {
  id           Int      @id @default(autoincrement())
  userId       Int
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  deviceId     String
  lastVerified DateTime
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([userId, deviceId])
  @@index([userId])
  @@index([expiresAt])
}

// =====================================================
// MODELO: Project
// =====================================================
model Project {
  id Int @id @default(autoincrement())

  clienteId Int
  cliente   Cliente @relation(fields: [clienteId], references: [id])

  contactoId Int?
  contacto   ContactoEmpresa? @relation(fields: [contactoId], references: [id])

  name        String
  createdById Int
  createdBy   User @relation(fields: [createdById], references: [id])

  cotizaciones Cotizacion[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clienteId])
}

// =====================================================
// MODELO: Cotizacion
// =====================================================
model Cotizacion {
  id                      Int              @id @default(autoincrement())
  name                    String
  code                    String           @unique
  status                  CotizacionStatus @default(ENVIADO)

  // Campos del estudio
  studyType               String
  metodologia             String?
  trabajoDeCampo          Boolean
  numeroOlasBi            Int?

  // Datos técnicos
  totalEntrevistas        Int
  duracionCuestionarioMin Int
  tipoEntrevista          String
  penetracionCategoria    Int
  cobertura               String
  supervisores            Int
  encuestadoresTotales    Int
  realizamosCuestionario  Boolean
  realizamosScript        Boolean
  clienteSolicitaReporte  Boolean
  clienteSolicitaInformeBI Boolean
  incentivoTotal          Int?

  // Totales
  factorComisionablePct   Float?
  factorNoComisionablePct Float?
  totalCobrar             Float?
  costoPorEntrevista      Float?

  // Relaciones
  project     Project   @relation(fields: [projectId], references: [id])
  projectId   Int

  contacto    ContactoEmpresa? @relation(fields: [contactoId], references: [id])
  contactoId  Int?

  createdBy   User     @relation(fields: [createdById], references: [id])
  createdById Int

  items       CotizacionItem[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// =====================================================
// MODELO: CotizacionItem
// =====================================================
// Relacionado con Cotización, se eliminarán automáticamente
// cuando se borre la cotización (onDelete: Cascade)
model CotizacionItem {
  id           Int        @id @default(autoincrement())
  cotizacionId Int
  cotizacion   Cotizacion @relation(fields: [cotizacionId], references: [id], onDelete: Cascade)

  category         String
  description      String
  personas         Decimal? @db.Decimal(12, 2)
  dias             Decimal? @db.Decimal(12, 2)
  costoUnitario    Decimal? @db.Decimal(14, 4)
  costoTotal       Decimal? @db.Decimal(14, 4)
  comisionable     Boolean
  totalConComision Decimal? @db.Decimal(14, 4)
  orden            Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([cotizacionId])
  @@index([category])
}
