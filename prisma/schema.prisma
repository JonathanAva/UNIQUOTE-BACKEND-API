// =====================================================
// GENERADOR DE CLIENTE PRISMA
// =====================================================
generator client {
  provider = "prisma-client-js"
}

// =====================================================
// FUENTE DE DATOS (PostgreSQL)
// =====================================================
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =====================================================
// ENUMS
// =====================================================

/// Estados de la cotización para manejar el flujo comercial
/// En el frontend puedes mapearlos a textos bonitos:
/// ENVIADO → "Enviado", NEGOCIACION → "Negociación", etc.
enum CotizacionStatus {
  ENVIADO
  NEGOCIACION
  APROBADO
  NO_APROBADO
  EN_PAUSA
  REEMPLAZADA
}

// =====================================================
// MODELO: Role
// =====================================================
model Role {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  users     User[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =====================================================
// MODELO: User
// =====================================================
model User {
  id                Int       @id @default(autoincrement())
  name              String
  lastName          String
  email             String    @unique
  phone             String
  password          String
  roleId            Int
  role              Role      @relation(fields: [roleId], references: [id])
  mfaLastVerifiedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  emailOtps      EmailOtp[]
  trustedDevices TrustedDevice[]

  projects     Project[]
  cotizaciones Cotizacion[]
}

// =====================================================
// MODELO: Cliente
// =====================================================
model Cliente {
  id          Int      @id @default(autoincrement())
  empresa     String
  razonSocial String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  contactos ContactoEmpresa[]
  projects  Project[]

  @@unique([empresa, razonSocial])
  @@index([empresa])
}

// =====================================================
// MODELO: ContactoEmpresa
// =====================================================
model ContactoEmpresa {
  id        Int     @id @default(autoincrement())
  clienteId Int
  cliente   Cliente @relation(fields: [clienteId], references: [id], onDelete: Cascade)

  nombre    String
  email     String   @unique
  telefono  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projects     Project[]
  cotizaciones Cotizacion[]

  @@index([clienteId])
}

// =====================================================
// MODELO: EmailOtp
// =====================================================
model EmailOtp {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  codeHash  String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
}

// =====================================================
// MODELO: TrustedDevice
// =====================================================
model TrustedDevice {
  id           Int      @id @default(autoincrement())
  userId       Int
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  deviceId     String
  lastVerified DateTime
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([userId, deviceId])
  @@index([userId])
  @@index([expiresAt])
}

// =====================================================
// MODELO: Project
// =====================================================
model Project {
  id Int @id @default(autoincrement())

  clienteId Int
  cliente   Cliente @relation(fields: [clienteId], references: [id])

  contactoId Int?
  contacto   ContactoEmpresa? @relation(fields: [contactoId], references: [id])

  name        String
  projectType String
  studyType   String

  createdById Int
  createdBy   User @relation(fields: [createdById], references: [id])

  cotizaciones Cotizacion[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clienteId])
  @@index([projectType])
}

// =====================================================
// MODELO: Cotizacion
// =====================================================
model Cotizacion {
  id Int @id @default(autoincrement())

  projectId Int
  project   Project @relation(fields: [projectId], references: [id])

  // Contacto específico de ese cliente para esta cotización (opcional)
  contactoId Int?
  contacto   ContactoEmpresa? @relation(fields: [contactoId], references: [id])

  // Nombre amigable de la cotización
  name String

  // Código interno legible (ej. "COT-<projectId>-<secuencia>")
  code String

  status CotizacionStatus @default(ENVIADO)

  createdById Int
  createdBy   User @relation(fields: [createdById], references: [id])

  // ----------------------------
  // Inputs principales de negocio
  // ----------------------------
  totalEntrevistas         Int
  duracionCuestionarioMin  Int
  tipoEntrevista           String
  penetracionCategoria     String
  cobertura                String
  supervisores             Int
  encuestadoresTotales     Int
  realizamosCuestionario   Boolean
  realizamosScript         Boolean
  clienteSolicitaReporte   Boolean
  clienteSolicitaInformeBI Boolean
  incentivoTotal           Decimal? @db.Decimal(12, 2)

  // ----------------------------
  // Totales / resultados globales
  // ----------------------------
  factorComisionablePct   Decimal? @db.Decimal(5, 2)
  factorNoComisionablePct Decimal? @db.Decimal(5, 2)
  totalCobrar             Decimal? @db.Decimal(14, 2)
  costoPorEntrevista      Decimal? @db.Decimal(14, 4)

  items CotizacionItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
  @@index([status])
  @@index([contactoId])
  // índice combinado útil para stats por cliente + contacto
  @@index([projectId, contactoId])
}

// =====================================================
// MODELO: CotizacionItem
// =====================================================
model CotizacionItem {
  id           Int        @id @default(autoincrement())
  cotizacionId Int
  cotizacion   Cotizacion @relation(fields: [cotizacionId], references: [id])

  category         String
  description      String
  personas         Decimal? @db.Decimal(12, 2)
  dias             Decimal? @db.Decimal(12, 2)
  costoUnitario    Decimal? @db.Decimal(14, 4)
  costoTotal       Decimal? @db.Decimal(14, 4)
  comisionable     Boolean
  totalConComision Decimal? @db.Decimal(14, 4)
  orden            Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([cotizacionId])
  @@index([category])
}
