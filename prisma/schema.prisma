// =====================================================
// GENERADOR DE CLIENTE PRISMA
// =====================================================
generator client {
  provider = "prisma-client-js"
}

// =====================================================
// FUENTE DE DATOS (PostgreSQL)
// =====================================================
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =====================================================
// ENUMS
// =====================================================

/// Estados de la cotización para manejar el flujo comercial
enum CotizacionStatus {
  ENVIADO
  NEGOCIACION
  APROBADO
  NO_APROBADO
  EN_PAUSA
  REEMPLAZADA
}

// =====================================================
// MODELO: Role
// =====================================================
model Role {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  users     User[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =====================================================
// MODELO: User
// =====================================================
model User {
  id                Int       @id @default(autoincrement())
  name              String
  lastName          String
  email             String    @unique
  phone             String
  password          String

  roleId            Int
  role              Role      @relation(fields: [roleId], references: [id])

  mfaLastVerifiedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  emailOtps      EmailOtp[]
  trustedDevices TrustedDevice[]
  projects       Project[]
  cotizaciones   Cotizacion[]
}

// =====================================================
// MODELO: Cliente
// =====================================================
model Cliente {
  id          Int      @id @default(autoincrement())
  empresa     String
  razonSocial String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  contactos ContactoEmpresa[]
  projects  Project[]

  @@unique([empresa, razonSocial])
  @@index([empresa])
}

// =====================================================
// MODELO: ContactoEmpresa
// =====================================================
model ContactoEmpresa {
  id        Int     @id @default(autoincrement())
  clienteId Int
  cliente   Cliente @relation(fields: [clienteId], references: [id], onDelete: Cascade)

  nombre    String
  email     String   @unique
  telefono  String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projects     Project[]
  cotizaciones Cotizacion[]

  @@index([clienteId])
}

// =====================================================
// MODELO: EmailOtp
// =====================================================
model EmailOtp {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  codeHash  String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
}

// =====================================================
// MODELO: TrustedDevice
// =====================================================
model TrustedDevice {
  id           Int      @id @default(autoincrement())
  userId       Int
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  deviceId     String
  lastVerified DateTime
  expiresAt    DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, deviceId])
  @@index([userId])
  @@index([expiresAt])
}

// =====================================================
// MODELO: Project
// =====================================================
model Project {
  id Int @id @default(autoincrement())

  clienteId Int
  cliente   Cliente @relation(fields: [clienteId], references: [id])

  contactoId Int?
  contacto   ContactoEmpresa? @relation(fields: [contactoId], references: [id])

  name        String
  createdById Int
  createdBy   User @relation(fields: [createdById], references: [id])

  cotizaciones Cotizacion[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clienteId])
}

// =====================================================
// MODELO: Cotizacion
// =====================================================
/// Modelo central donde se almacena toda la información de una cotización.
/// Con los nuevos campos para trabajo de campo:
/// - trabajoDeCampoRealiza (boolean)
/// - trabajoDeCampoTipo ("propio" | "subcontratado")
/// - trabajoDeCampoCosto (monto si es subcontratado)
model Cotizacion {
  id                      Int              @id @default(autoincrement())
  name                    String
  code                    String           @unique
  status                  CotizacionStatus @default(ENVIADO)

  // Tipo de estudio
  studyType               String
  metodologia             String?

  // NUEVOS CAMPOS CORRECTOS
  trabajoDeCampoRealiza   Boolean
  trabajoDeCampoTipo      String?      // 'propio' | 'subcontratado'
  trabajoDeCampoCosto     Float?       // monto si es subcontratado

  numeroOlasBi            Int?

  // Datos técnicos
  totalEntrevistas        Int
  duracionCuestionarioMin Int
  tipoEntrevista          String
  penetracionCategoria    Int
  cobertura               String
  supervisores            Int
  encuestadoresTotales    Int
  realizamosCuestionario  Boolean
  realizamosScript        Boolean
  clienteSolicitaReporte  Boolean
  clienteSolicitaInformeBI Boolean
  incentivoTotal          Int?

  // Totales
  factorComisionablePct   Float?
  factorNoComisionablePct Float?
  totalCobrar             Float?
  costoPorEntrevista      Float?

  // Relaciones
  project   Project @relation(fields: [projectId], references: [id])
  projectId Int

  contacto   ContactoEmpresa? @relation(fields: [contactoId], references: [id])
  contactoId Int?

  createdBy   User @relation(fields: [createdById], references: [id])
  createdById Int

  items CotizacionItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =====================================================
// MODELO: CotizacionItem
// =====================================================
model CotizacionItem {
  id           Int        @id @default(autoincrement())
  cotizacionId Int
  cotizacion   Cotizacion @relation(fields: [cotizacionId], references: [id], onDelete: Cascade)

  category         String
  description      String
  personas         Decimal? @db.Decimal(12, 2)
  dias             Decimal? @db.Decimal(12, 2)
  costoUnitario    Decimal? @db.Decimal(14, 4)
  costoTotal       Decimal? @db.Decimal(14, 4)
  comisionable     Boolean
  totalConComision Decimal? @db.Decimal(14, 4)
  orden            Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([cotizacionId])
  @@index([category])
}

// =====================================================
// MODELO: Constante
// =====================================================
/// Constantes de cálculo dinámico utilizadas en el motor de cotización.
/// Estas pueden agruparse por categoría y subcategoría.
/// Ejemplos:
/// - categoría: "Trabajo de Campo", subcategoría: "Viático - San Miguel"
/// - categoría: "Procesamiento", subcategoría: "Codificación"
model Constante {
  id           Int      @id @default(autoincrement())

  /// Categoría general (ej. Trabajo de Campo, Recursos, Dirección, Procesamiento)
  categoria    String

  /// Subcategoría específica (ej. Viático - San Miguel, Pago Encuestador Diario)
  subcategoria String

  /// Valor numérico editable
  valor        Float

  /// Unidad opcional (ej. "$", "por hora", "USD", etc.)
  unidad       String?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  /// Cada combinación categoría + subcategoría debe ser única
  @@unique([categoria, subcategoria])
  @@index([categoria])
}
